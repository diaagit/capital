"use client";

import * as RadioGroup from "@radix-ui/react-radio-group";
import { BadgeCent, CreditCard } from "lucide-react";
import { useEffect, useState } from "react";
import { cn } from "@/lib/utils";
import { Checkbox } from "../ui/checkbox";
import { Separator } from "@/components/ui/separator";
import axios from "axios";
import getBackendUrl from "@/lib/config";
import Image from "next/image";

interface BackendResponse {
  data: CardProps[];
  message: string;
}

interface CardProps {
  id: string;
  bank_name: string;
  card_number: string;
  balance: string;
  created_at: string;
}

interface Props {
  card: string,
  setCard: (card: string) => void;
}

export const getCardBrand = (cardNumber: string) => {
  if (cardNumber.startsWith("3"))
    return <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
              <g className="nc-icon-wrapper">
                <rect x="2" y="7" width="28" height="18" rx="3" ry="3" fill="#141413" strokeWidth="0"></rect>
                <path d="m27,7H5c-1.657,0-3,1.343-3,3v12c0,1.657,1.343,3,3,3h22c1.657,0,3-1.343,3-3v-12c0-1.657-1.343-3-3-3Zm2,15c0,1.103-.897,2-2,2H5c-1.103,0-2-.897-2-2v-12c0-1.103.897-2,2-2h22c1.103,0,2,.897,2,2v12Z" strokeWidth="0" opacity=".15"></path>
                <path d="m27,8H5c-1.105,0-2,.895-2,2v1c0-1.105.895-2,2-2h22c1.105,0,2,.895,2,2v-1c0-1.105-.895-2-2-2Z" fill="#fff" opacity=".2" strokeWidth="0"></path>
                <path fill="#ff5f00" strokeWidth="0" d="M13.597 11.677H18.407V20.32H13.597z"></path>
                <path d="m13.902,15.999c0-1.68.779-3.283,2.092-4.322-2.382-1.878-5.849-1.466-7.727.932-1.863,2.382-1.451,5.833.947,7.712,2,1.573,4.795,1.573,6.795,0-1.329-1.038-2.107-2.642-2.107-4.322Z" fill="#eb001b" strokeWidth="0"></path>
                <path d="m24.897,15.999c0,3.039-2.459,5.497-5.497,5.497-1.237,0-2.428-.412-3.39-1.176,2.382-1.878,2.795-5.329.916-7.727-.275-.336-.58-.657-.916-.916,2.382-1.878,5.849-1.466,7.712.932.764.962,1.176,2.153,1.176,3.39Z" fill="#f79e1b" strokeWidth="0"></path>
              </g>
            </svg>;

  if (cardNumber.startsWith("5"))
    return <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
              <g className="nc-icon-wrapper">
                <rect x="2" y="7" width="28" height="18" rx="3" ry="3" fill="#e6e6e6" strokeWidth="0"></rect>
                <path d="m27,7H5c-1.657,0-3,1.343-3,3v12c0,1.657,1.343,3,3,3h22c1.657,0,3-1.343,3-3v-12c0-1.657-1.343-3-3-3Zm2,15c0,1.103-.897,2-2,2H5c-1.103,0-2-.897-2-2v-12c0-1.103.897-2,2-2h22c1.103,0,2,.897,2,2v12Z" opacity=".15" strokeWidth="0"></path>
                <path d="m27,8H5c-1.105,0-2,.895-2,2v1c0-1.105.895-2,2-2h22c1.105,0,2,.895,2,2v-1c0-1.105-.895-2-2-2Z" fill="#fff" opacity=".2" strokeWidth="0"></path>
                <path id="path236" d="m26.2763,13.7579l1.307,2.5952-2.7476,2.5965,1.4406-5.1917Z" fill="#008c44" strokeWidth="0"></path>
                <path id="path240" d="m25.3713,13.7579l1.3051,2.5952-2.7458,2.5965,1.4407-5.1917Z" fill="#f47920" strokeWidth="0"></path>
                <path id="path244" d="m4.4167,18.0053l1.3031-4.6949h2.0834c.6511,0,1.0861.1031,1.3073.3155.2197.2107.262.5546.1296,1.038-.0801.2848-.2018.5238-.3691.7127-.1659.1892-.3847.3388-.6541.4488.2286.055.374.1641.4392.3277.0648.1636.0573.4022-.0214.7149l-.1585.6558-.0005.0177c-.0457.1836-.0322.2819.0423.2899l-.048.1738h-1.4094c.0048-.1105.0135-.2092.0229-.2922.0102-.0849.0229-.1506.0354-.1958l.1314-.4689c.0662-.2438.0703-.4139.0089-.5119-.062-.1006-.2008-.1501-.4199-.1501h-.5923l-.4517,1.6187h-1.3787Zm2.1234-2.6767h.6344c.2223,0,.3864-.0317.4875-.0974.1016-.0662.177-.1781.2213-.3398.0458-.1645.0346-.2792-.0312-.3444-.0656-.0662-.2228-.0984-.4698-.0984h-.598l-.2443.88Z" fill="#1b3281" strokeWidth="0"></path>
                <path id="path248" d="m13.1082,14.5409l-.9607,3.4644h-1.1674l.1435-.5075c-.2055.2018-.4157.3551-.6277.453-.2102.0997-.4321.1487-.6657.1487-.1931,0-.3588-.035-.4923-.1046-.135-.0693-.2356-.1746-.3033-.3136-.0601-.1216-.0862-.2718-.076-.4512.0108-.1766.0732-.4744.1887-.8915l.4979-1.7978h1.277l-.4968,1.7894c-.0726.2619-.0899.446-.0545.5462.0369.1011.1353.1534.295.1534.1609,0,.2961-.0583.4079-.1771.1133-.1179.2008-.2936.2666-.5276l.4927-1.7843h1.2751Z" fill="#1b3281" strokeWidth="0"></path>
                <path id="path252" d="m12.6449,18.0053l1.3018-4.6949h1.7908c.3951,0,.7009.0233.919.0745.2176.049.3883.1287.5152.241.1589.1469.2563.3287.2964.5468.0377.2181.0154.4722-.0671.7705-.1459.5248-.4015.927-.7658,1.208-.3654.2774-.8176.4167-1.3572.4167h-.838l-.3981,1.4374h-1.3969Zm2.1123-2.584h.4503c.2911,0,.4958-.036.6157-.1054.116-.0703.1985-.1952.2488-.3728.0503-.18.0373-.3058-.0387-.3761-.0732-.07-.2601-.1054-.5592-.1054h-.4494l-.2676.9597Z" fill="#1b3281" strokeWidth="0"></path>
                <path id="path256" d="m18.903,18.0053l.013-.329c-.2059.1542-.4145.2707-.6241.3435-.2088.0742-.4311.1118-.6692.1118-.3617,0-.6139-.0983-.7598-.2885-.144-.1906-.1677-.4642-.0694-.8132.0941-.3445.2614-.5981.5029-.7602.2401-.1641.641-.2815,1.2035-.3566.0713-.0116.1669-.0209.2866-.0354.4158-.0481.6493-.1589.6996-.3397.0262-.099.0102-.172-.0512-.2168-.0593-.0465-.1701-.0694-.3301-.0694-.1328,0-.2396.0275-.3272.0848-.0875.0578-.1528.1422-.1971.261h-1.245c.1124-.39.3421-.6847.687-.8817.3436-.2005.7966-.2969,1.3577-.2969.2638,0,.5001.0247.709.0783.2092.0513.3621.1245.4613.213.1221.1105.1943.2364.2149.3757.0238.1389-.0023.338-.0751.5985l-.5355,1.9315c-.0172.0633-.0205.1197-.0111.171.0111.0489.0325.0908.0703.1207l-.0288.0978h-1.2822Zm.3104-1.5469c-.1356.0545-.3118.1067-.5309.1641-.3439.0923-.5375.2154-.5793.3677-.029.098-.0173.1734.0306.2307.0472.0545.1292.082.2448.082.212,0,.3822-.0536.509-.1594.1272-.1072.2223-.2754.2889-.5075.0116-.0494.0218-.0849.0284-.1114l.0084-.0662Z" fill="#1b3281" strokeWidth="0"></path>
                <path id="path260" d="m20.195,19.3705l.2834-1.0254h.3654c.1221,0,.2181-.0241.2861-.068.0691-.0456.116-.1225.1431-.2261.0135-.0456.0218-.0936.0275-.1481.0036-.0578.0036-.1189,0-.1897l-.195-3.1723h1.2926l-.02,2.102,1.1284-2.102h1.202l-1.9949,3.4477c-.2264.3853-.3909.6501-.4954.7946-.1031.1427-.2009.2536-.2959.3287-.1231.1039-.2605.1775-.4089.2204-.1487.0438-.3751.0656-.6794.0656-.0876,0-.1884-.0017-.2974-.0074-.1082-.0042-.2237-.0107-.3417-.02" fill="#1b3281" strokeWidth="0"></path>
              </g>
            </svg>

  if (cardNumber.startsWith("6"))
    return <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
              <g className="nc-icon-wrapper">
                <rect x="2" y="7" width="28" height="18" rx="3" ry="3" fill="#1434cb" strokeWidth="0"></rect>
                <path d="m27,7H5c-1.657,0-3,1.343-3,3v12c0,1.657,1.343,3,3,3h22c1.657,0,3-1.343,3-3v-12c0-1.657-1.343-3-3-3Zm2,15c0,1.103-.897,2-2,2H5c-1.103,0-2-.897-2-2v-12c0-1.103.897-2,2-2h22c1.103,0,2,.897,2,2v12Z" strokeWidth="0" opacity=".15"></path>
                <path d="m27,8H5c-1.105,0-2,.895-2,2v1c0-1.105.895-2,2-2h22c1.105,0,2,.895,2,2v-1c0-1.105-.895-2-2-2Z" fill="#fff" opacity=".2" strokeWidth="0"></path>
                <path d="m13.392,12.624l-2.838,6.77h-1.851l-1.397-5.403c-.085-.332-.158-.454-.416-.595-.421-.229-1.117-.443-1.728-.576l.041-.196h2.98c.38,0,.721.253.808.69l.738,3.918,1.822-4.608h1.84Z" fill="#fff" strokeWidth="0"></path>
                <path d="m20.646,17.183c.008-1.787-2.47-1.886-2.453-2.684.005-.243.237-.501.743-.567.251-.032.943-.058,1.727.303l.307-1.436c-.421-.152-.964-.299-1.638-.299-1.732,0-2.95.92-2.959,2.238-.011.975.87,1.518,1.533,1.843.683.332.912.545.909.841-.005.454-.545.655-1.047.663-.881.014-1.392-.238-1.799-.428l-.318,1.484c.41.188,1.165.351,1.947.359,1.841,0,3.044-.909,3.05-2.317" fill="#fff" strokeWidth="0"></path>
                <path d="m25.423,12.624h-1.494c-.337,0-.62.195-.746.496l-2.628,6.274h1.839l.365-1.011h2.247l.212,1.011h1.62l-1.415-6.77Zm-2.16,4.372l.922-2.542.53,2.542h-1.452Z" fill="#fff" strokeWidth="0"></path>
                <path fill="#fff" strokeWidth="0" d="M15.894 12.624L14.446 19.394 12.695 19.394 14.143 12.624 15.894 12.624z"></path>
              </g>
            </svg>

  return null;
};

const PaymentMethods = ({card,setCard}: Props) => {
  const [useCard, setUseCard] = useState(false);
  const [selectedCard, setSelectedCard] = useState("");
  const [cards, setCards] = useState<CardProps[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    setCard(selectedCard);
  }, [selectedCard, setCard]);

  useEffect(() => {
    const URL = getBackendUrl();
    const token = localStorage.getItem("token");

    const getCards = async () => {
      try {
        const res = await axios.get<BackendResponse>(`${URL}/user/my/cards`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        setCards(res.data.data ?? []);
      } catch {
        setCards([]);
      } finally {
        setLoading(false);
      }
    };

    getCards();
  }, []);

  const formatDate = (dateStr: string) =>
    new Date(dateStr).toLocaleDateString(undefined, {
      day: "numeric",
      month: "short",
      year: "numeric",
    });

  return (
    <div className="h-full bg-white rounded-xl border shadow-sm flex flex-col overflow-hidden">
      <div className="px-6 py-4 border-b">
        <h1 className="text-xl font-semibold">Confirm Booking</h1>
        <p className="text-sm text-gray-500">
          Review your details & proceed to payment
        </p>
      </div>

      <div className="flex-1 px-6 py-6 space-y-8 overflow-y-auto">
        <div className="space-y-3">
          <h2 className="text-lg font-medium">Capital Rewards</h2>

          <label className="flex items-center gap-4 rounded-lg border px-5 py-4 cursor-pointer hover:bg-neutral-50">
            <Checkbox />
            <div className="w-14 h-10 flex items-center justify-center bg-red-50 border rounded-md">
              <BadgeCent className="w-5 h-5 text-red-700" />
            </div>
            <div>
              <p className="text-sm font-medium">Capcoins</p>
              <p className="text-xs text-gray-500">
                Use available rewards for this booking
              </p>
            </div>
            <div className="ml-auto font-semibold">₹0.00</div>
          </label>
        </div>

        <Separator />

        <div className="space-y-4">
          <h2 className="text-lg font-medium">Payment Method</h2>

          <div
            onClick={() => setUseCard((v) => !v)}
            className={cn(
              "flex items-center gap-4 rounded-lg border p-4 cursor-pointer transition",
              useCard
                ? "border-blue-600 bg-blue-50"
                : "border-gray-200 hover:border-gray-300"
            )}
          >
            <Checkbox checked={useCard} />
            <div className="w-14 h-10 flex items-center justify-center bg-blue-50 border rounded-md">
              <CreditCard className="w-5 h-5 text-blue-700" />
            </div>
            <div>
              <p className="text-sm font-medium">Credit / Debit Card</p>
              <p className="text-xs text-gray-500">
                Visa, Mastercard, RuPay supported
              </p>
            </div>
          </div>
          <div
            className={cn(
              "grid transition-all duration-300 ease-in-out",
              useCard
                ? "grid-rows-[1fr] opacity-100 mt-2"
                : "grid-rows-[0fr] opacity-0"
            )}
          >
            <div className="overflow-hidden ml-9 space-y-3">
              {loading &&
                Array.from({ length: 2 }).map((_, i) => (
                  <div
                    key={i}
                    className="h-[64px] rounded-lg border bg-gray-100 animate-pulse"
                  />
                ))}

              {!loading && cards.length === 0 && (
                <p className="text-sm text-gray-500">
                  No saved cards available
                </p>
              )}

              {!loading && cards.length > 0 && (
                <RadioGroup.Root
                  value={selectedCard}
                  onValueChange={setSelectedCard}
                  className="space-y-3"
                >
                  {cards.map((card) => {
                    const brand = getCardBrand(card.card_number);

                    return (
                      <label
                        key={card.id}
                        className={cn(
                          "flex items-center gap-4 rounded-lg border px-4 py-3 cursor-pointer transition",
                          selectedCard === card.card_number
                            ? "border-blue-600 bg-blue-50"
                            : "border-gray-200 hover:border-gray-300"
                        )}
                      >
                        <RadioGroup.Item
                          value={card.card_number}
                          className="h-4 w-4 rounded-full border
                          data-[state=checked]:border-blue-600
                          data-[state=checked]:bg-blue-600"
                        />

                        <div className="flex flex-col flex-1">
                          <p className="text-sm font-medium">
                            {card.bank_name[0].toUpperCase() +
                              card.bank_name.slice(1)}{" "}
                            •••• {card.card_number.slice(-4)}
                          </p>
                          <p className="text-xs text-gray-500">
                            Added on {formatDate(card.created_at)}
                          </p>
                        </div>

                        {brand && typeof brand === "string" ? (
                          <Image
                            src={brand}
                            alt="card brand"
                            width={32}
                            height={32}
                          />
                        ) : (
                          brand
                        )}

                        <div className="text-sm font-semibold">
                          ₹{card.balance}
                        </div>
                      </label>
                    );
                  })}
                </RadioGroup.Root>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default PaymentMethods;